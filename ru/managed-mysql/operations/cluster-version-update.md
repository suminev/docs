# Обновление версии {{ MY }}

Вы можете обновить кластер {{ mmy-name }} до любой поддерживаемой версии: минорной или мажорной.

В однохостовых кластерах на обновление выводится единственный хост-мастер. Во время обновления такие кластеры недоступны для чтения и записи, в отличие от кластеров из двух и более хостов.

В многохостовых кластерах обновление проводится в следующем порядке:

1. Хосты-реплики последовательно выводятся на обновление и отключаются. Порядок реплик в очереди определяется случайным образом. После обновления реплики возвращаются в работу.
1. Мастер закрывается на запись. Среди реплик [выбирается новый мастер](../concepts/replication.md#master-failover), который открывается для записи. В результате кластер обновляется с минимальным временем простоя.
1. Исходный мастер отключается, обновляется и возвращается в роли реплики. Обратно мастер не переключается.

Об обновлениях в рамках одной версии и обслуживании хостов см. в разделе [{#T}](../concepts/maintenance.md).

{% note alert %}

* После обновления СУБД вернуть кластер к предыдущей версии невозможно.
* Успешность обновления версии {{ MY }} зависит от многих факторов, в том числе от настроек кластера и данных, хранящихся в базах. Рекомендуется сначала [обновить тестовый кластер](#before-update), который использует те же данные и настройки.
* Обновляйте кластер в период низкой нагрузки на него.

{% endnote %}

## Перед обновлением версии {#before-update}

Убедитесь, что обновление не нарушит работу ваших приложений:

1. Посмотрите в [истории изменений](https://docs.percona.com/percona-server/8.0/release-notes/release-notes_index.html) {{ MY }}, как обновления могут повлиять на работу ваших приложений.
1. Попробуйте обновить версию на тестовом кластере. Его можно развернуть из резервной копии основного кластера. Для тестового кластера используйте окружение `PRESTABLE`.
1. [Создайте резервную копию](cluster-backups.md) основного кластера непосредственно перед обновлением версии.
1. Так как кластер из трех и более хостов является отказоустойчивым, убедитесь, что в основном и тестовом кластере есть хотя бы два хоста-реплики и один хост-мастер. При необходимости [добавьте хосты](hosts.md#add).

## Обновить кластер {#start-update}

{% list tabs group=instructions %}

- Консоль управления {#console}

   1. Перейдите на страницу каталога и выберите сервис **{{ ui-key.yacloud.iam.folder.dashboard.label_managed-mysql }}**.
   1. Выберите нужный кластер в списке и нажмите кнопку ![image](../../_assets/pencil.svg) **{{ ui-key.yacloud.mdb.cluster.overview.button_action-edit }}**.
   1. В поле **{{ ui-key.yacloud.mdb.forms.base_field_version }}** выберите номер новой версии.
   1. Нажмите кнопку **{{ ui-key.yacloud.mdb.forms.button_edit }}**.

   После запуска обновления кластер переходит в статус **Updating**. Дождитесь окончания операции и проверьте версию кластера.

   Время обновления зависит от многих факторов, например от объема данных или количества баз данных в кластере. Обновление обычно занимает несколько минут, для больших БД — от 10 минут.

- CLI {#cli}

   {% include [cli-install](../../_includes/cli-install.md) %}

   {% include [default-catalogue](../../_includes/default-catalogue.md) %}

   Чтобы обновить версию {{ MY }}:

   1. Получите список ваших кластеров {{ MY }} командой:

      ```bash
      {{ yc-mdb-my }} cluster list
      ```

   1. Получите информацию о нужном кластере и проверьте версию {{ MY }}, указанную в свойстве `config.version`:

      ```bash
      {{ yc-mdb-my }} cluster get <имя_или_идентификатор_кластера>
      ```

   1. Запустите обновление {{ MY }}:

      ```bash
      {{ yc-mdb-my }} cluster update <имя_или_идентификатор_кластера> \
         --mysql-version <номер_новой_версии>
      ```

   Время обновления зависит от многих факторов, например от объема данных или количества баз данных в кластере. Обновление обычно занимает несколько минут, для больших БД — от 10 минут.

- {{ TF }} {#tf}

   1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

      О том, как создать такой файл, см. в разделе [{#T}](cluster-create.md).

   1. Добавьте поле `version` в ресурс `yandex_mdb_mysql_cluster` или измените значение поля, если оно уже существует:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя_кластера>" {
         ...
         version = "<версия_{{ MY }}>"
         ...
      }
      ```

   1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

   1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

   Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mmy }}).

   {% include [Terraform timeouts](../../_includes/mdb/mmy/terraform/timeouts.md) %}

- API {#api}

   Чтобы обновить кластер до определенной версии {{ MY }}, воспользуйтесь методом REST API [update](../api-ref/Cluster/update.md) для ресурса [Cluster](../api-ref/Cluster/index.md) или вызовом gRPC API [ClusterService/Update](../api-ref/grpc/cluster_service.md#Update) и передайте в запросе:

   * Идентификатор кластера в параметре `clusterId`. Чтобы узнать идентификатор, [получите список кластеров в каталоге](./cluster-list.md#list-clusters).
   * Номер версии {{ MY }} в параметре `configSpec.version`.
   * Список изменяемых полей конфигурации кластера в параметре `updateMask`.

   {% include [Note API updateMask](../../_includes/note-api-updatemask.md) %}

   Время обновления зависит от многих факторов, например от объема данных или количества баз данных в кластере. Обновление обычно занимает несколько минут, для больших БД — от 10 минут.

{% endlist %}

## Примеры {#examples}

Допустим, нужно обновить кластер с версии 5.7 до версии 8.0.

{% list tabs group=instructions %}

- CLI {#cli}

   1. Чтобы получить список кластеров и узнать их идентификаторы и имена, выполните команду:

      ```bash
      {{ yc-mdb-my }} cluster list
      ```

      Пример результата:

      ```text
      +----------------------+------------+---------------------+--------+---------+
      |          ID          |    NAME    |     CREATED AT      | HEALTH | STATUS  |
      +----------------------+------------+---------------------+--------+---------+
      | c9q8p8j2gaih******** |  mysql406  | 2021-10-23 12:44:17 | ALIVE  | RUNNING |
      +----------------------+------------+---------------------+--------+---------+
      ```

   1. Чтобы получить информацию о кластере с именем `mysql406`, выполните команду:

      ```bash
      {{ yc-mdb-my }} cluster get mysql406
      ```

      Пример результата:

      ```text
        id: c9q8p8j2gaih********
        ...
        config:
          version: "5.7"
          ...
      ```

   1. Чтобы обновить кластер `mysql406` до версии 8.0, выполните команду:

      ```bash
      {{ yc-mdb-my }} cluster update mysql406 --mysql-version 8.0
      ```

- {{ TF }} {#tf}

   1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.
   1. В поле `version` в ресурсе `yandex_mdb_mysql_cluster` укажите значение `8.0`:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя_кластера>" {
         ...
         version = "8.0"
         ...
      }
      ```

   1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

   1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

{% endlist %}
